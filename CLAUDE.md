# workhub会議室予約 AI Agent 学習記録

## 概要

このドキュメントは、AI Agentがworkhub会議室予約の自動化で学んだことを記録します。
エラーパターン、成功パターン、画面の特徴などを蓄積し、次回の実行に活用します。

---

## 1. 基本情報

| 項目 | 値 |
|------|-----|
| workhub URL | https://admin.workhub.site |
| エリア予約URL | https://admin.workhub.site/reservation-calendar |
| 認証状態ファイル | ./auth/workhub-auth.json |
| ワークフロー定義 | ./WORKFLOW.md |

---

## 2. agent-browserコマンド構文

### 重要なルール

```bash
# ✅ 正しい構文（ref番号を引用符で括る）
agent-browser click "@e1"
agent-browser fill "@e1" "テキスト"

# ❌ 間違った構文（引用符なし）
agent-browser click @e1
agent-browser fill @e1 "テキスト"
```

### よく使うコマンド

| コマンド | 用途 | 例 |
|----------|------|-----|
| `open` | URLを開く | `agent-browser open "https://..." --headed` |
| `snapshot -i` | 画面要素取得 | `agent-browser snapshot -i` |
| `click` | クリック | `agent-browser click "@e15"` |
| `fill` | テキスト入力 | `agent-browser fill "@e1" "会議"` |
| `screenshot` | スクリーンショット | `agent-browser screenshot "result.png"` |
| `state load` | 認証復元 | `agent-browser state load "auth/workhub-auth.json"` |
| `state save` | 認証保存 | `agent-browser state save "auth/workhub-auth.json"` |
| `close` | ブラウザ終了 | `agent-browser close` |

---

## 3. 画面の特徴

### 3.1 ログイン画面

- ログインボタンは初期状態で `[disabled]`
- メールアドレスとパスワードを入力すると有効化される
- ログイン成功後、トップ画面にリダイレクト

### 3.2 エリア予約画面

- カレンダー形式で会議室の予約状況を表示
- 横軸: 時間（30分刻み）
- 縦軸: 会議室

#### 空き時間の判別方法

| 要素タイプ | 意味 | 例 |
|------------|------|-----|
| `button [ref=eXXX] [nth=YYY]` | 空き時間 | クリック可能 |
| `button "日時, 会議室名, 予約済み"` | 予約済み | 予約詳細表示 |

### 3.3 予約フォーム

- 空き時間スロットをクリックすると表示
- ダイアログ形式
- 時間選択はcombobox → option選択の2ステップ

### 3.4 確認ダイアログ

- 「作成」ボタンクリック後に表示
- 「キャンセル」と「登録」の2つのボタン
- **「登録」をクリックして予約確定**（2段階確認）

---

## 4. 成功パターン

### パターン1: 基本的な予約フロー

**日付:** 2026-02-03  
**シナリオ:** 翌日のPhoneBooth 4Aを14:30-15:30で予約

**手順:**
1. `state load` で認証復元
2. エリア予約画面を開く
3. 「翌日」ボタンで日付移動
4. 空きスロット（ラベルなしbutton）をクリック
5. タイトル入力: `fill "@e1" "テスト予約"`
6. 開始時間: comboboxクリック → 14:30選択
7. 終了時間: comboboxクリック → 15:30選択
8. 「作成」ボタンクリック
9. 確認ダイアログで「登録」ボタンクリック
10. カレンダーに予約が表示されることを確認

**結果:** ✅ 成功

**学んだこと:**
- 予約完了には「作成」→「登録」の2段階が必要
- 終了時間は開始時間以降のみ選択可能
- 予約成功後はカレンダー画面に自動で戻る

---

## 5. エラーパターンと対処法

### エラー1: 要素が見つからない

**状況:** `click "@e5"` で要素が存在しない

**原因:** ページ遷移後にref番号が変わった

**対処:**
```bash
# 操作前に必ずsnapshotでrefを再取得
agent-browser snapshot -i
# 新しいref番号を確認してから操作
```

**教訓:** ref番号は画面状態で変わるため、毎回snapshotで確認する

---

### エラー2: ログインセッション切れ

**状況:** エリア予約画面を開くとログイン画面にリダイレクト

**原因:** 認証状態の有効期限切れ

**対処:**
```bash
# 認証状態を再作成
agent-browser open "https://admin.workhub.site/" --headed
agent-browser snapshot -i
agent-browser fill "@e1" "${EMAIL}"
agent-browser fill "@e2" "${PASSWORD}"
agent-browser click "@e5"
agent-browser state save "auth/workhub-auth.json"
```

**教訓:** 定期的に認証状態を更新する仕組みが必要

---

### エラー3: 予約フォームが開かない

**状況:** 空きスロットをクリックしても反応なし

**原因:** 
- クリックした要素が実際には予約済みだった
- 画面がまだ読み込み中だった

**対処:**
1. snapshotで画面状態を確認
2. 別の空きスロット（ラベルなしbutton）を探す
3. 少し待ってから再試行

**教訓:** 空きスロットはラベルなしbuttonで判別する

---

### エラー4: Daemon failed to start

**状況:** agent-browserコマンド実行時にデーモンエラー

**原因:** Playwrightブラウザが未インストール

**対処:**
```bash
npx playwright install chromium
```

**教訓:** 初回セットアップ時にPlaywrightのインストールが必要

---

### エラー5: executable-path ignored

**状況:** `--executable-path`オプションが無視される

**原因:** 既存のデーモンが別の設定で起動中

**対処:**
```bash
# 既存デーモンを終了
agent-browser close
# 環境変数を設定してから再起動
export AGENT_BROWSER_EXECUTABLE_PATH="/path/to/chrome"
agent-browser open "https://..." --headed
```

**教訓:** デーモン起動中は設定変更が反映されない

---

## 6. 画面要素のref番号パターン

### 注意事項

- ref番号は画面状態により変動する
- 以下は参考パターンであり、実際の操作では必ずsnapshotで確認すること

### エリア予約画面（典型的なパターン）

| 要素 | 典型的なref範囲 | 備考 |
|------|----------------|------|
| 会議室タブ | e11〜e12 | - |
| 検索ボックス | e13 | - |
| フィルターボタン | e14〜e20 | - |
| 前日/翌日/今日 | e21〜e23 | - |
| カレンダースロット | e25〜e600+ | 大量のボタン |
| 予約済みスロット | ラベル付き | 日時・会議室名含む |

### 予約フォーム（典型的なパターン）

| 要素 | 典型的なref | 備考 |
|------|------------|------|
| タイトル | e1 | textbox |
| 開始日 | e2 | textbox |
| 開始日カレンダー | e3 | button |
| 開始時間 | e4 | combobox |
| 終了日 | e5 | textbox |
| 終了日カレンダー | e6 | button |
| 終了時間 | e7 | combobox |
| 従業員選択 | e11 | button |
| キャンセル | e14 | button |
| 作成 | e15 | button |

### 確認ダイアログ

| 要素 | 典型的なref | 備考 |
|------|------------|------|
| キャンセル | e16 | button |
| 登録 | e17 | button |

---

## 7. 会議室選択の優先順位

### 人数別推奨

| 人数 | 推奨会議室 |
|------|-----------|
| 1名 | PhoneBooth（5D〜5G, 4A〜4B） |
| 2〜4名 | 02_5A会議室、02_5C会議室 |
| 5〜8名 | 02_5B会議室 |

### 用途別推奨

| 用途 | 推奨会議室 |
|------|-----------|
| 電話・Web会議 | PhoneBooth |
| 対面ミーティング | 5A, 5B, 5C会議室 |
| 集中作業 | PhoneBooth |

---

## 8. トラブルシューティングチェックリスト

予約が失敗した場合、以下を確認:

- [ ] 認証状態は有効か？（ログイン画面にリダイレクトされていないか）
- [ ] snapshotでref番号を確認したか？
- [ ] クリックしたスロットは空きか？（ラベルなしbuttonか）
- [ ] 予約フォームは表示されたか？
- [ ] 「作成」と「登録」の両方をクリックしたか？
- [ ] カレンダーに予約が表示されたか？

---

## 9. 今後の改善点

### 調査が必要な項目

- [ ] 認証状態の有効期限（何時間/何日持つか）
- [ ] 予約のキャンセル方法
- [ ] 予約の変更方法
- [ ] 繰り返し予約の設定方法
- [ ] 複数人の参加者追加方法

### 実装改善案

- [ ] 認証状態の自動更新機能
- [ ] 予約失敗時の自動リトライ
- [ ] 空き会議室の自動検索・提案
- [ ] 予約完了のSlack通知

---

## 改訂履歴

| 版 | 日付 | 内容 |
|----|------|------|
| 1.0 | 2026-02-03 | 初版作成（実際の画面調査・予約テスト結果に基づく） |
